---
title: "R Notebook"
author: Nicholas Fraser
output: github_document
---

```{r echo = F, include = F, message = F, warning = F}
# Load necessary libraries
library(tidyverse)

# Set chart themes
theme_set(theme_light() +
          theme(text = element_text(size=12),
                axis.text.x = element_text(angle=45, hjust=1),
                axis.title.x = element_text(margin = margin(t = 15, unit = "pt")),
                axis.title.y = element_text(margin = margin(r = 15, unit = "pt")),
                plot.title = element_text(margin = margin(t = 5, b = 15, unit = "pt"),
                                          hjust = 0.5),
                panel.spacing = unit(1, "lines"),
                strip.background = element_blank(),
                strip.text = element_text(colour = "grey10")))

# Color palette
# From https://www.materialui.co/colors
palette <- c(
  `closed`      = "#9E9E9E",
  `open`        = "#00BCD4",
  `gold`        = "#FDD835",
  `hybrid`      = "#FB8C00",
  `bronze`      = "#BF360C",
  `green`       = "#4CAF50",
  `light green` = "#A5D6A7",
  `dark green`  = "#2E7D32")

palette_color <- function(color) {
  cols <- c(color)
  if (is.null(cols)) {
    return(NA)
  } else {
    return(unname(palette[color]))
  }
}
```

# Open Access and Altmetrics

This R notebook contains documentation for the study on the relationship between Open Access (OA) and altmetrics.

## Background

[TBC]

Important:
* https://doi.org/10.1007/s11192-019-03301-x
* https://doi.org/10.1002/bult.2013.1720390406
* https://doi.org/10.3145/epi.2020.ene.02
* https://openaccess.leidenuniv.nl/handle/1887/65221
* https://www.ideals.illinois.edu/bitstream/handle/2142/73451/212_ready.pdf


## Research Questions

The study aims to address the following research questions: 

- **RQ1**: Do OA articles receive more altmetric attention than non-OA articles?
- **RQ2**: Do articles with different *types* of OA differ in the altmetric attention they receive?
- **RQ3**: Which additional factors influence the relationship between OA and altmetrics?
- **RQ4**: What are the limitations with current data sources in measuring the large-scale relationship between OA and altmetrics?

With respect to RQ3, the following factors will be investigated:

- Time
- Document types (article versus review documents)
- Discipline
- Country of authorship
- Publication venue (journal prestige)

## Data Sources

### Article Corpus (Web of Science)

Articles were derived from the in-house Web of Science (WOS) database maintained by CWTS ([query](queries/create_table_wos_items.sql)).

The following tables were used to build the article corpus:

- woskb.dbo.cwts_ut
- woskb.dbo.cwts_pub_details

Extracted fields included:

- ut
- doi (limited to non-null values)
- year (limited to 2012:2018)
- n_authors
- n_institutes
- n_countries
- source (journal name)
- doc type (limited to 'Article' and 'Review')

DOIs were converted to lowercase for matching with other datasets (e.g. Unpaywall, Altmetric.com).

##### Distribution of WOS articles per year ([query](queries/calc_wos_items_year.sql))

```{r echo = F, message = F, warning = F}

read_csv("data/wos_items_year.csv") %>%
  ggplot() +
  geom_bar(aes(x = year, y = n_items), stat = "identity") +
  labs(x = "", 
       y = "Articles") +
  scale_x_continuous(breaks = 2012:2018) +
  scale_y_continuous(labels = scales::comma)

```

### Author Countries

ISO Alpha-2 country codes of **first** authors were extracted for the set of articles defined above ([query](queries/create_table_wos_first_author_countries.sql)), combining the following tables:

- userdb_frasernm.dbo.wos_items (as defined above)
- wosaddr1913.dbo.pub_author_affiliation
- wosaddr1913.dbo.pub_affiliation
- wosaddr1913.dbo.country

Two potential methods for counting of country affiliations were explored: full counting and fractional counting. Full counting means that a paper is fully associated with any country affiliation of an author, e.g. if an author has two affiliations, one in the US and one in the UK, the paper would be counted as an article for the output of both countries. Fractional counting means that where an author has affiliations in multiple countries, an article is weighted by the number of country affiliations of the author, e.g. for an author with affiliations in the US and UK, an article would count as 0.5 towards the output of the UK, and 0.5 towards the output of the US.

##### Top 50 countries included in the WOS article corpus by full counting ([query](queries/calc_wos_items_country_full_counting.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 6}

read_csv("data/wos_items_country_full_counting.csv") %>%
  mutate(country = countrycode::countrycode(country, "iso2c", "country.name"),
         proportion = n_items / sum(n_items)) %>%
  top_n(50, proportion) %>%
  ggplot(aes(x = reorder(country, proportion), y = proportion)) +
  geom_bar(stat = "identity") + 
  labs(x = "",
       y= "Articles") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme(text = element_text(size = 10))

```

##### Top 50 countries included in WOS article corpus by fractional counting ([query](queries/calc_wos_items_country_fractional_counting.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 6}

read_csv("data/wos_items_country_fractional_counting.csv") %>%
  mutate(country = countrycode::countrycode(country, "iso2c", "country.name"),
         proportion = n_items / sum(n_items)) %>%
  top_n(50, proportion) %>%
  ggplot(aes(x = reorder(country, proportion), y = proportion)) +
  geom_bar(stat = "identity") + 
  labs(x = "",
       y= "Articles") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme(text = element_text(size = 10))

```

##### Difference in country output using full versus fractional

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 6}

read_csv("data/wos_items_country_fractional_counting.csv") %>%
  inner_join(read_csv("data/wos_items_country_full_counting.csv"), 
             by = "country") %>%
  mutate(country = countrycode::countrycode(country, "iso2c", "country.name"),
         delta = n_items.x/n_items.y) %>%
  top_n(50, n_items.x) %>%
  ggplot(aes(x = reorder(country, n_items.x), y = delta)) +
  geom_bar(stat = "identity") + 
  labs(x = "",
       y= "Ratio Fractional Counting:Full Counting") +
  scale_y_continuous() +
  coord_flip() +
  theme(text = element_text(size = 10))

```

#### Recommendations for counting methodology

The results show that per-country output varies strongly depending on whether full or fractional counting is used (in some cases, e.g. in Saudi Arabia, counts are nearly 20 % lower when using fractional versus full counting). Potential reasons for this may be that authors from smaller countries, or countries with less well-developed scientific systems, are more likely to need to collaborate with partners from other countries, or that collaborations are driven by external motivations such as funding sources which explicitly require multi-country collaborations (e.g. EU FP7). To prevent penalisation of authors in these countries, for the following study full-counting at the country level is used.

### Subject Classifications

Subject classifications are assigned to 5 major subject areas, which conform to the subject classifications used in the [Leiden Ranking](https://leidenranking.com). The fields are defined algorithmically (as outlined [here](https://leidenranking.com/information/fields)), based on the publication-level classification system detailed in [Waltman and van Eck (2012)](https://onlinelibrary.wiley.com/doi/full/10.1002/asi.22748). In brief terms, publications are initially clustered into research areas at 3 levels of granularity, based on citation relations. The classification system here uses the level of highest granularity, where publications are clustered into 4535 micro-level fields of science. For each micro-level field, the overlap with each of the 252 WOS subject areas (excluding Multidisciplinary Sciences) is determined. Each of these 252 subject categories is then assigned to the 5 main fields of the Leiden Ranking.

For this study, classification was conducted using the following tables ([query](queries/create_table_wos_classification.sql)):

- userdb_frasernm.dbo.wos_items (as defined above)
- wosclassification1913.dbo.clustering
- wosclassification1913.dbo.cluster_LR_main_field3
- wosclassification1913.dbo.LR_main_field

For subject classification, we use only fractional counting to weight articles towards their respective subject (i.e. a publication belonging to both "Biomedical and Health Sciences" and "Life and Earth Sciences" would be assigned a weight of 0.5 for both fields).

##### Proportion of WOS articles contained in each subject classification ([query](queries/calc_wos_items_classification.sql))

```{r echo = F, message = F, warning = F}

read_csv("data/wos_items_classification.csv") %>%
  mutate(proportion = n_items / sum(n_items)) %>%
  arrange(proportion) %>%
  ggplot(aes(x = reorder(LR_main_field, proportion), y = proportion)) +
  geom_bar(stat = "identity") + 
  labs(x = "",
       y= "Articles") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme(text = element_text(size = 10))

```

### Altmetrics Data

Altmetrics data were derived from the CWTS in-house database of Altmetric.com (version October 2019) ([query](queries/create_table_altmetric_counts.sql)), using the following tables:

- userdb_frasernm.dbo.wos_items (as defined above)
- altmetric_2019oct.dbo.pub_citation
- altmetric_2019oct.dbo.pub_counts

Counts were initially extracted for the following altmetric indicators:

- Blogs
- Facebook
- News
- Policy
- Twitter
- Wikipedia

Where no altmetric information was found for an article, counts were registered as zero.

The following metrics are used for measuring altmetric activity:

- **Altmetric Coverage**: The number of articles that are mentioned in a given altmetric source. E.g. if 30 articles out of 100 total articles are mentioned on Twitter, the Twitter coverage is 30%.
- **Relative Altmetric Coverage**: The number of articles that are mentioned in a given altmetric source **for a specific subset of a population**, relative to the entire population. This can be explained with the following example: a population of 100 articles consists of 40 OA and 60 non-OA articles. The Twitter coverage of the entire population is 30%, but the coverage of the OA group is 50%. Thus, the relative coverage of the OA group is 50/30 = 1.66. An interpretation is that OA articles are mentioned 66% more often on Twitter than the population as a whole.

### OA Classification

OA classification was conducted using data from Unpaywall. Unpaywall data (from the April 2019 data dump) has been parsed into a relational (SQL) database at CWTS. 

The following tables were used:

- unpaywall_2019apr_json.dbo.pub (article details)
- unpaywall_2019apr_json.dbo.pub_oa_location (article oa location details)

Articles were limited to those with a publication date between 2010 and 2019. This is slightly more inclusive than the WOS articles (2012-2019), to account for potential differences in recorded publication years between the two datasets (and thus ensures maximum coverage of WoS articles in the Unpaywall dataset).

OA classification was first conducted following the workflow detailed in Figure 1 from [Robinson-Garcia et al. (2019)](https://arxiv.org/abs/1906.03840):

![robinson_garcia_unpaywall_classification](figures/external/robinson_garcia_unpaywall_classification.PNG)

This classification scheme diverges from the OA classification scheme [used by Unpaywall directly](https://support.unpaywall.org/support/solutions/articles/44001777288-what-do-the-types-of-oa-status-green-gold-hybrid-and-bronze-mean-) in two ways:

* Green OA is a non-exclusive category, meaning that it can overlap with other journal-based OA categories. E.g. a paper can be published in a Gold OA journal, and hosted on a Green OA repository, and would thus be labelled both 'Gold' and 'Green'.
* Articles hosted on PubMed Central (PMC) are, however, not classified as Green OA *if* they are available through another OA outlet. As authors do not submit manuscripts to PMC directly, it is not a 'self-archiving' repository in the 'traditional' sense.

Some implications of these two points are considered below.

#### PMC

To test the influence of the inclusion/exclusion of articles contained in PMC on Green OA rates, two classification procedures were conducted: one including all PMC articles in Green OA ([create_table_unpaywall_classification_nopmccor.sql](queries/create_table_unpaywall_classification_nopmccor.sql)), and one excluding PMC articles from Green OA when they match with an alternative kind of OA ([create_table_unpaywall_classification_pmccor.sql](queries/create_table_unpaywall_classification_pmccor.sql)).

##### Green OA articles in Unpaywall including and excluding PMC ([query](queries/calc_unpaywall_classification_pmc_comparison.sql))

```{r echo = F, message = F, warning = F}

read_csv("data/unpaywall_classification_pmc_comparison.csv",
         col_types = "nln") %>%
  mutate(pmc_corrected = factor(pmc_corrected,
                                levels = c(T, F))) %>%
  ggplot(aes(x = year, y = green, fill = pmc_corrected)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "", 
       y = "Green OA articles",
       fill = "Excludes PMC") +
  scale_x_continuous(breaks = 2010:2019) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("dark green"),
                               palette_color("light green")))
```

PMC contributes a large proportion of Green OA from 2010 to 2017. In 2018 and 2019, no PMC articles are found to contribute to Green OA  - notably, no articles are found for these year in the Unpaywall data where the evidence is described as "oa repository (via pmcid lookup)". However, when checking the same articles from 2018 and 2019 directly via the Unpaywall API, PMC *is* included as an evidence source. A possibility is that Unpaywall only crawl PMC sporadically (as articles in Gold OA journals, such as PLOS ONE, are deposited immediately to PMC), or that a technical issue occurred [**to do:** investigate this issue further. Contact Unpaywall?]

##### Overlap of articles in PMC with journal-based OA types ([query](queries/calc_unpaywall_classification_pmc_overlap.sql))

```{r echo = F, message = F, warning = F}

read_csv("data/unpaywall_classification_pmc_overlap.csv") %>%
  pivot_longer(closed:bronze) %>%
  # there is no overlap between closed and PMC
  filter(name != "closed") %>%
  mutate(type = factor(name,
                       levels = c("gold", "hybrid", "bronze"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = value, fill = type),
           stat = "identity", position = "dodge", width = 0.75) +
  labs(x = "", 
       y = "Articles",
       fill = "OA Type") +
  scale_x_continuous(breaks = 2010:2019) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze")))

```

PMC appears to overlap most strongly (and overlap has grown most rapidly) with Gold OA, but also a non-negligible amount with Hybrid and Bronze OA. Note, as previously, PMC articles are missing from 2018 and 2019.

#### Exclusivity of Green OA

Following the classification procedure of Robinson-Garcia et al. (2019), Green OA is treated as a non-exclusive category, i.e. an article is labelled as Green if it is available via a repository, regardless of its availability status at the journal page. However, some questions remain about this approach in the context of understanding OA impact - for example, from the readership perspective, will readers really use (and be more likely to cite/mention) an article if it is an OA repository, when it is also available directly on a journal page? And from the authors perspective - do the authors who publish in OA journals **and** self-archive their papers represent a different demographic/category of authors, than those who **only** self-archive? The impact dynamics are therefore likely different for Green OA, depending on the availability of the corresponding journal article.

##### Number of articles in repositories that are open and closed at the corresponding journal page ([query](queries/calc_unpaywall_classification_green_types.sql))

```{r echo = F, message = F, warning = F}

read_csv("data/unpaywall_classification_green_types.csv") %>%
  pivot_longer(all_green:only_green) %>%
  filter(name %in% c("journal_oa_green", "only_green")) %>%
  mutate(name = factor(name,
                       levels = c("only_green",
                                  "journal_oa_green"),
                       labels = c("Closed at journal page",
                                  "Open at journal page"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = value, fill = name), 
           stat = "identity", position = "dodge", width = 0.75) +
  labs(x = "", 
       y = "Articles",
       title = "Articles in repositories by journal article availability",
       fill = "Article availability") +
  scale_x_continuous(breaks = 2010:2019) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("dark green"),
                               palette_color("light green")))

```

It appears tha growth in Green OA between 2010 and 2017 is stronger for articles which are also available at the corresponding journal page, than closed articles. Note, however, that the above figures includes PMC articles - as shown in the previous section, there is also a large overlap of PMC with Gold OA, and to a lesser extent with Hybrid and Bronze OA.

##### Number of Green OA articles published in different types of OA journals ([query](queries/calc_unpaywall_classification_green_types.sql))

```{r echo = F, message = F, warning = F}

read_csv("data/unpaywall_classification_green_types.csv") %>%
  pivot_longer(all_green:only_green) %>%
  filter(name %in% c("gold_green", "hybrid_green", "bronze_green")) %>%
  mutate(name = factor(name,
                       levels = c("gold_green",
                                  "hybrid_green",
                                  "bronze_green"),
                       labels = c("Gold",
                                  "Hybrid",
                                  "Bronze"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = value, fill = name),
           stat = "identity", position = "dodge", width = 0.75) +
  labs(x = "", 
       y = "Articles",
       title = "Green OA by journal type",
       fill = "OA Type") +
  scale_x_continuous(breaks = 2010:2019) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze")))

```

The results show that the contribution of Gold articles to Green OA shares has grown most strongly between 2010 and 2017. However, approximately 75% of the growth can be attributed to growth in deposits to PMC. Interestingly, whilst the contribution of Hybrid OA has grown over this time period, the contribution of Bronze OA remains relatively static, and even falls marginally from 2014 onwards.

#### Recommendations for classifying Green OA

From the above results, a general recommendation is that Green OA should not be considered a 'black box' in the context of understanding impact metrics, as it includes multiple archiving routes, and interacts strongly with other forms of OA. However, creating many other 'categories' of Green OA (i.e. one category for Green OA including PMC and one excluding PMC) for analysis purposes is also sub-optimal, as categories will become increasingly granular and large-scale mechanisms influencing impact are lost.

For simplification purposes, PMC is therefore excluded as a form of Green OA in this study. The reasoning for this is based on: (1) that PMC clearly represents a different *form* of archiving than other forms of Green OA, i.e. the author takes no direct action to deposit their work, (2) that PMC largely overlaps with other forms of journal-based OA, in particular with Gold OA, which may skew results towards these OA forms, and (3) there exist data quality issues, with respect to missing PMC data in 2018 and 2019.

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 4}

p1 <- read_csv("data/altmetrics_coverage_year_oa.csv") %>%
  mutate(type = factor(type, levels = c("closed", "open"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("open"))) +
  labs(x = "",
       y = "Articles",
       fill = "")


p2 <- read_csv("data/altmetrics_coverage_year_oa_types.csv") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Articles",
       fill = "")

egg::ggarrange(p1,
               p2, nrow = 2, heights = c(1,1))


```


## Results

### Altmetric Coverage and OA

Here the large-scale relationship between coverage of altmetric indicators and their OA status is explored.

#### By Year

Note: Year refers to the WOS publication year (not the publication year stored by Unpaywall)

##### Total altmetric coverage per indicator ([query](queries/calc_altmetrics_coverage_year.sql))

```{r echo = F, message = F, warning = F, fig.height = 3, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_year.csv") %>%
  ggplot() +
  geom_bar(aes(x = year, y = items), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  labs(x = "",
       y = "Articles")

p2 <- read_csv("data/altmetrics_coverage_year.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(coverage = items_covered / items) %>%
  ggplot() +
  geom_point(aes(x = year, y = coverage), 
             shape = 21, fill = "grey50", color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(. ~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  labs(x = "",
       y = "Coverage (%)")

egg::ggarrange(p1 + theme(axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)),
               p2, nrow = 1, widths = c(1,6))

```

The highest coverage is observed in Twitter, followed by Facebook, then news and blogs, Wikipedia and policies. Different temporal trends are observed for each indicator, e.g. Twitter coverage increases between 2012 and 2016, which may reflect rapid user growth on the platform itself. Conversely, policy citations decrease over time, likely because policy citations take longer to accrue (~years) than mentions on social media (~days to weeks) (see [Fang and Costas, 2018](https://openaccess.leidenuniv.nl/handle/1887/65278)).

##### Relative altmetric coverage in OA versus non-OA publications ([query](queries/calc_altmetrics_coverage_year_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_year_oa.csv") %>%
  mutate(type = factor(type, levels = c("closed", "open"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("open"))) +
  labs(x = "",
       y = "Articles",
       fill = "")
         
p2 <- read_csv("data/altmetrics_coverage_year_oa.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items) %>%
  group_by(year, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = year, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")

p3 <- read_csv("data/altmetrics_coverage_year_oa.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items) %>%
  group_by(year, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = year, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")

egg::ggarrange(p1 + theme(legend.position = "none",
                          axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top",
                          axis.title.x = element_blank(),),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none",
                          axis.title.x = element_blank()),
               nrow = 2, ncol = 2, widths = c(1,6))

```

In general terms, OA articles receive greater coverage in all altmetric indicators than non-OA articles for all years. The advantage is surprisingly stable across altmetric indicators, with values of relative coverage between 1.25-1.75 for OA articles (i.e. OA articles receive 25-75 % more coverage than the baseline coverage of all articles). For some indicators, e.g. Facebook, news articles, Twitter and Wikipedia, the relative coverage of OA articles reduces over time, whilst for blogs relative coverage remains relatively stable, and even increases marginally for policies.

##### Relative altmetric coverage in different access types ([query](queries/calc_altmetrics_coverage_year_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_year_oa_types.csv") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  ggplot() +
  geom_bar(aes(x = year, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Articles",
       fill = "")

p2 <- read_csv("data/altmetrics_coverage_year_oa_types.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items) %>%
  group_by(year, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = year, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")


p3 <- read_csv("data/altmetrics_coverage_year_oa_types.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items) %>%
  group_by(year, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = year, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2012, 2014, 2016, 2018)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")

egg::ggarrange(p1 + theme(legend.position = "none",
                          axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top",
                          axis.title.x = element_blank(),),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none",
                          axis.title.x = element_blank()),
               nrow = 2, ncol = 2, widths = c(1,6))

```

Different trends are observed within each type of OA. A broad generalisation is that for most indicators, with the exception of Twitter, Bronze OA 'performs' well with respect to relative coverage, whilst Gold OA performs poorly. However, the temporal trends are not entirely clear - for example, with respect to Facebook, the relative coverage of Gold OA was in fact the highest of all types of OA in 2012, but by 2018 the decreases to the lowest of all OA types. Policy documents in particular show a large separation in coverage between Gold OA and other types of OA - the reasons for this will be investigated in a later section.

#### By Document Type

##### Total altmetric coverage per indicator ([query](queries/calc_altmetrics_coverage_doctype.sql))

```{r echo = F, message = F, warning = F, fig.height = 3, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_doctype.csv") %>%
  ggplot() +
  geom_bar(aes(x = doc_type, y = items), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "",
       y = "Articles")

p2 <- read_csv("data/altmetrics_coverage_doctype.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(coverage = items_covered / items) %>%
  ggplot() +
  geom_point(aes(x = doc_type, y = coverage), 
             shape = 21, fill = "grey50", color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(. ~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "",
       y = "Coverage (%)")

egg::ggarrange(p1 + theme(axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)),
               p2, nrow = 1, widths = c(1,6))

```
##### Relative altmetric coverage in OA versus non-OA publications ([query](queries/calc_altmetrics_coverage_doctype_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_doctype_oa.csv") %>%
  mutate(type = factor(type, levels = c("closed", "open"))) %>%
  ggplot() +
  geom_bar(aes(x = doc_type, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("open"))) +
  labs(x = "",
       y = "Articles",
       fill = "")
         
p2 <- read_csv("data/altmetrics_coverage_doctype_oa.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items) %>%
  group_by(doc_type, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = doc_type, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")

p3 <- read_csv("data/altmetrics_coverage_doctype_oa.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items) %>%
  group_by(doc_type, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = doc_type, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")

egg::ggarrange(p1 + theme(legend.position = "none",
                          axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top",
                          axis.title.x = element_blank(),),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none",
                          axis.title.x = element_blank()),
               nrow = 2, ncol = 2, widths = c(1,6))

```

##### Relative altmetric coverage in different access types ([query](queries/calc_altmetrics_coverage_doctype_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_doctype_oa_types.csv") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  ggplot() +
  geom_bar(aes(x = doc_type, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Articles",
       fill = "")

p2 <- read_csv("data/altmetrics_coverage_doctype_oa_types.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items) %>%
  group_by(doc_type, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = doc_type, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")

p3 <- read_csv("data/altmetrics_coverage_doctype_oa_types.csv") %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items) %>%
  group_by(doc_type, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = doc_type, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")

egg::ggarrange(p1 + theme(legend.position = "none",
                          axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top",
                          axis.title.x = element_blank(),),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none",
                          axis.title.x = element_blank()),
               nrow = 2, ncol = 2, widths = c(1,6))

```

#### By Classification

##### Abbrevations for subject classifications

```{r echo = F, message = F, warning = F}

# A helper function to reclassify Leiden Ranking fields to abbreviated titles
abbreviate_classifications <- function(d) {
  d %>%
    mutate(classification = factor(classification,
           levels = c("Biomedical and health sciences",
                      "Life and earth sciences",
                      "Mathematics and computer science",
                      "Physical sciences and engineering",
                      "Social sciences and humanities"),
           labels = c("BHS", "LES", "MCS", "PSE", "SSH")))
}

```

For the following section, names of individual subject classifications are abbreviated as follows:

- BHS: Biomedical and Health Sciences
- LES: Life and Earth Sciences
- MCS: Mathematics and Computer Sciences
- PSE: Physical Sciences and Engineering
- SSH: Social Sciences and Humanities

##### Total altmetric coverage per indicator ([query](queries/calc_altmetrics_coverage_classification.sql))

```{r echo = F, message = F, warning = F, fig.height = 3, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_classification.csv") %>%
  abbreviate_classifications() %>%
  ggplot() +
  geom_bar(aes(x = classification, y = items), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "",
       y = "Articles")

p2 <- read_csv("data/altmetrics_coverage_classification.csv") %>%
  abbreviate_classifications() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(coverage = items_covered / items) %>%
  ggplot() +
  geom_point(aes(x = classification, y = coverage), 
             shape = 21, fill = "grey50", color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(. ~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "",
       y = "Coverage (%)")

egg::ggarrange(p1 + theme(axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)),
               p2, nrow = 1, widths = c(1,6))

```

Higher altmetric coverage is observed in BHS, LES and SSH than MCS and PSE. SSH has the highest coverage on blogs and in policy documents, whilst on Facebook and Twitter the highest coverage is observed in BHS. MCS has the lowest coverage across all indicators. 

##### Relative altmetric coverage in OA versus non-OA publications ([query](queries/calc_altmetrics_coverage_classification_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_classification_oa.csv") %>%
  abbreviate_classifications() %>%
  mutate(type = factor(type, levels = c("closed", "open"))) %>%
  ggplot() +
  geom_bar(aes(x = classification, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("open"))) +
  labs(x = "",
       y = "Articles",
       fill = "")
         
p2 <- read_csv("data/altmetrics_coverage_classification_oa.csv") %>%
  abbreviate_classifications() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items) %>%
  group_by(classification, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = classification, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")

p3 <- read_csv("data/altmetrics_coverage_classification_oa.csv") %>%
  abbreviate_classifications() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items) %>%
  group_by(classification, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = classification, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")

egg::ggarrange(p1 + theme(legend.position = "none",
                          axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top",
                          axis.title.x = element_blank(),),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none",
                          axis.title.x = element_blank()),
               nrow = 2, ncol = 2, widths = c(1,6))

```

Interestingly, whilst PSE and MCS were shown in the previous figure to have generally lower coverage across all indicators than other subject classifications, the relative coverage of OA publications in PSE and MCS is generally higher than in BHS, LES and SSH. An exception to this is in policy mentions, where relative coverage of OA publication in PSE is similar to LES and SSH, whilst in MCS the relative coverage of OA publications is only slightly greater than 1. 

##### Relative altmetric coverage in different access types ([query](queries/calc_altmetrics_coverage_classification_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_classification_oa_types.csv") %>%
  abbreviate_classifications() %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  ggplot() +
  geom_bar(aes(x = classification, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Articles",
       fill = "")

p2 <- read_csv("data/altmetrics_coverage_classification_oa_types.csv") %>%
  abbreviate_classifications() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items) %>%
  group_by(classification, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = classification, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")


p3 <- read_csv("data/altmetrics_coverage_classification_oa_types.csv") %>%
  abbreviate_classifications() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items) %>%
  group_by(classification, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = classification, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")

egg::ggarrange(p1 + theme(legend.position = "none",
                          axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top",
                          axis.title.x = element_blank(),),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none",
                          axis.title.x = element_blank()),
               nrow = 2, ncol = 2, widths = c(1,6))

```

High coverage of PSE in OA publications appears to be driven mainly by Green and Bronze OA. With respect to blogs and Wikipedia, Bronze OA has by far the highest coverage, which appears to be driven strongly by a small selection of 'high impact' journals in Astronomy. Conversely, for Twitter and Facebook, the highest coverage in PSE is in Green OA - it would be interesting to investigate whether this is due to availability of Green OA on arXiv.

#### By Country

```{r echo = F, message = F, warning = F}

# Select the top countries by publising volume
top_countries <- read_csv("data/altmetrics_coverage_country.csv") %>%
  mutate(region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent")) %>%
  na.omit() %>%
  group_by(region) %>%
  filter(items > 1000) %>%
  arrange(desc(items)) %>%
  slice(1:5) %>%
  pull(country)

```

For the following analysis, the top 5 countries per region (Africa, Americas, Europe, Asia, Oceania) by publishing volume are included. For Oceania, only Australia and New Zealand are included as publishing volumes for other countries were found to be extremely low.

##### Total altmetric coverage per indicator ([query](queries/calc_altmetrics_coverage_country.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_country.csv") %>%
  filter(country %in% top_countries) %>%
  mutate(region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  ggplot() +
  geom_bar(aes(x = reorder(country, items), y = items), stat = "identity") +
  facet_grid(region ~ ., scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "",
       y = "Articles") +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))
  
p2 <- read_csv("data/altmetrics_coverage_country.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(coverage = items_covered / items,
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  ggplot() +
  geom_point(aes(x = reorder(country, items), y = coverage), 
             shape = 21, fill = "grey50", color = "grey10", size = 3, alpha = 0.5) +
  facet_grid(region ~ indicator, scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "",
       y = "Coverage (%)")  +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

egg::ggarrange(p1 + theme(plot.margin = margin(0, 10, 0, 0)),
               p2, 
               nrow = 1, 
               widths = c(1,6))

```

##### Relative altmetric coverage in OA versus non-OA publications ([query](queries/calc_altmetrics_coverage_country_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 16}

p1 <- read_csv("data/altmetrics_coverage_country_oa.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  ggplot() +
  geom_bar(aes(x = reorder(country, items), y = items, fill = type), 
           stat = "identity") +
  facet_grid(region ~ ., scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("open"),
                               palette_color("closed"))) +
  labs(x = "",
       y = "Articles") +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

p2 <- read_csv("data/altmetrics_coverage_country_oa.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items,
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  ggplot() +
  geom_point(aes(x = reorder(country, items), y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_grid(region ~ indicator, scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("open"),
                               palette_color("closed"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")  +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

p3 <- read_csv("data/altmetrics_coverage_country_oa.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed")),
         coverage = items_covered / items,
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  group_by(country, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = reorder(country, items), y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_grid(region ~ indicator, scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("open"),
                               palette_color("closed"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")  +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

egg::ggarrange(p1 + theme(legend.position = "none",
                          plot.margin = margin(0, 10, 0, 0)), 
               p2 + theme(legend.position = "top",
                          plot.margin = margin(0, 10, 0, 0)),
               p3 + theme(legend.position = "none"),
               nrow = 1, ncol = 3, widths = c(1,6, 6))

```

##### Relative altmetric coverage in different access types ([query](queries/calc_altmetrics_coverage_country_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 16}

p1 <- read_csv("data/altmetrics_coverage_country_oa_types.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  ggplot() +
  geom_bar(aes(x = reorder(country, items), y = items, fill = type), 
           stat = "identity") +
  facet_grid(region ~ ., scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Articles") +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

p2 <- read_csv("data/altmetrics_coverage_country_oa_types.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items,
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  ggplot() +
  geom_point(aes(x = reorder(country, items), y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_grid(region ~ indicator, scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Coverage (%)",
       fill = "")  +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

p3 <- read_csv("data/altmetrics_coverage_country_oa_types.csv") %>%
  filter(country %in% top_countries) %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green")),
         coverage = items_covered / items,
         region = countrycode::countrycode(country, 
                                           origin = "iso2c",
                                           destination = "continent"),
         country = countrycode::countrycode(country,
                                            origin = "iso2c",
                                            destination = "country.name")) %>%
  group_by(country, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = reorder(country, items), y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_grid(region ~ indicator, scales = "free_y", space = "free") +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "",
       y = "Relative Coverage",
       fill = "")  +
  coord_flip() +
  theme(strip.background.y = element_rect(color = "grey75", fill = "grey90"))

egg::ggarrange(p1 + theme(legend.position = "none",
                          plot.margin = margin(0, 10, 0, 0)), 
               p2 + theme(legend.position = "top",
                          plot.margin = margin(0, 10, 0, 0)),
               p3 + theme(legend.position = "none"),
               nrow = 1, ncol = 3, widths = c(1,6, 6))

```

#### By Journal

There are 11,149 distinct journal titles associated with our WOS sample. In the following section, journals are grouped into percentiles on the basis of their Journal Impact Factor (downloaded from Clarivate Analytics Journal Citation Reports), as a proxy for journal prestige.

[To discuss: is JIF really a good proxy for journal prestige? Could we use some other measure? Should we correct for JIF variability between subject areas?]

```{r echo = F, message = F, warning = F}

journal_ifs <- read_csv("data/journal_impact_factors.csv") %>%
  na.omit() %>%
  mutate(journal = str_to_upper(journal)) %>%
  distinct(journal, journal_if, year) %>%
  group_by(journal) %>%
  summarize(mean_if = mean(journal_if))

join_and_bin_journal_ifs <- function(d) {
  d %>%
  mutate(journal = str_to_upper(journal)) %>%
  inner_join(journal_ifs, by = "journal") %>%
  mutate(bin = hutils::weighted_ntile(mean_if, weights = items, 10),
         percentile = paste0((bin-1)*10, "-", bin*10))
}

```

##### Total altmetric coverage per indicator ([query](queries/calc_altmetrics_coverage_journal.sql))

```{r echo = F, message = F, warning = F, fig.height = 3, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_journal.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  group_by(percentile) %>%
  summarize(items = sum(items)) %>%
  ggplot() +
  geom_bar(aes(x = percentile, y = items), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Impact Factor Percentile",
       y = "Articles") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))


p2 <- read_csv("data/altmetrics_coverage_journal.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  group_by(percentile, indicator) %>%
  summarize(items = sum(items),
            items_covered = sum(items_covered),
            coverage = items_covered / items) %>%
  ggplot() +
  geom_point(aes(x = percentile, y = coverage), 
             shape = 21, fill = "grey50", color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(. ~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Impact Factor Percentile",
       y = "Coverage (%)") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

egg::ggarrange(p1 + theme(axis.title.x = element_blank(),
                          plot.margin = margin(0, 30, 0, 0)),
               p2, nrow = 1, widths = c(1,6))

```

##### Relative altmetric coverage in OA versus non-OA publications ([query](queries/calc_altmetrics_coverage_journal_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_journal_oa.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  mutate(type = factor(type, levels = c("closed", "open"))) %>%
  group_by(percentile, type) %>%
  summarize(items = sum(items)) %>%
  ggplot() +
  geom_bar(aes(x = percentile, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("open"))) +
  labs(x = "Impact Factor Percentile",
       y = "Articles",
       fill = "") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

p2 <- read_csv("data/altmetrics_coverage_journal_oa.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  group_by(percentile, indicator, type) %>%
  summarize(items = sum(items),
            items_covered = sum(items_covered),
            coverage = items_covered/items) %>%
  ungroup() %>%
  ggplot() +
  geom_point(aes(x = percentile, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Impact Factor Percentile",
       y = "Coverage (%)",
       fill = "") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

p3 <- read_csv("data/altmetrics_coverage_journal_oa.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  group_by(percentile, indicator, type) %>%
  summarize(items = sum(items),
            items_covered = sum(items_covered),
            coverage = items_covered/items) %>%
  ungroup() %>%
  group_by(percentile, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = percentile, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Impact Factor Percentile",
       y = "Relative Coverage",
       fill = "") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

egg::ggarrange(p1 + theme(legend.position = "none",
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top"),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none"),
               nrow = 2, ncol = 2, widths = c(1,6))

```

##### Relative altmetric coverage in different access types ([query](queries/calc_altmetrics_coverage_journal_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 6, fig.width = 12}

p1 <- read_csv("data/altmetrics_coverage_journal_oa_types.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  group_by(percentile, type) %>%
  summarize(items = sum(items)) %>%
  ggplot() +
  geom_bar(aes(x = percentile, y = items, fill = type), stat = "identity") +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Impact Factor Percentile",
       y = "Articles",
       fill = "") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))
         
p2 <- read_csv("data/altmetrics_coverage_journal_oa_types.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  group_by(percentile, indicator, type) %>%
  summarize(items = sum(items),
            items_covered = sum(items_covered),
            coverage = items_covered/items) %>%
  ungroup() %>%
  ggplot() +
  geom_point(aes(x = percentile, y = coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Impact Factor Percentile",
       y = "Coverage (%)",
       fill = "") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

p3 <- read_csv("data/altmetrics_coverage_journal_oa_types.csv") %>%
  filter(items >= 100) %>%
  join_and_bin_journal_ifs() %>%
  pivot_longer(blogs:wikipedia,
               names_to = "indicator",
               values_to = "items_covered") %>%
  mutate(type = factor(type, 
                levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  group_by(percentile, indicator, type) %>%
  summarize(items = sum(items),
            items_covered = sum(items_covered),
            coverage = items_covered/items) %>%
  ungroup() %>%
  group_by(percentile, indicator) %>%
  mutate(rel_coverage = coverage / (sum(items_covered) / sum(items))) %>%
  ggplot() +
  geom_point(aes(x = percentile, y = rel_coverage, fill = type), 
             shape = 21, color = "grey10", size = 3, alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  facet_wrap(~ indicator, nrow = 1) +
  expand_limits(y = 0) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Impact Factor Percentile",
       y = "Relative Coverage",
       fill = "") +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

egg::ggarrange(p1 + theme(legend.position = "none",
                          plot.margin = margin(0, 30, 0, 0)), 
               p2 + theme(legend.position = "top"),
               ggplot() + theme(panel.border = element_blank()),
               p3 + theme(legend.position = "none"),
               nrow = 2, ncol = 2, widths = c(1,6))

```

* High coverage of Gold OA in blogs, Facebook and Twitter in 40-50th percentile. Not clear why - several large, biomedical/health-focused Gold OA journals (not including PLOS ONE) are in this category which have high counts.
* High Wikipedia coverage of Bronze OA in 40-50th percentile is due to high coverage in a single journal: "International Journal of Systematic and Evolutionary Microbiology" which is cited in Wikipedia 1476 times - the journal publishes papers which establish names of new bacteria. 

#### Rate of dissemination in altmetric sources

##### Twitter: OA versus non-OA ([query](queries/calc_twitter_timediff_oa.sql))

* Note: Triangles refer to the median time to the first tweet

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/twitter_timediff_oa.csv") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/twitter_min_timediff_oa.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.5, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_color_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all tweets received")

```

##### Twitter: all OA types ([query](queries/calc_twitter_timediff_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/twitter_timediff_oa_types.csv") %>%
  mutate(type = factor(type, 
                       levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/twitter_min_timediff_oa_types.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.5, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all tweets received")

```

##### Facebook: OA versus non-OA ([query](queries/calc_facebook_timediff_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/facebook_timediff_oa.csv") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/facebook_min_timediff_oa.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.75, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all facebook mentions received")

```

##### Facebook: all OA types ([query](queries/calc_facebook_timediff_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/facebook_timediff_oa_types.csv") %>%
  mutate(type = factor(type, 
                       levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/facebook_min_timediff_oa_types.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.5, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all facebook mentions received")

```

##### News: OA versus non-OA ([query](queries/calc_news_timediff_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/news_timediff_oa.csv") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/news_min_timediff_oa.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.75, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all news mentions received")

```

##### News: all OA types ([query](queries/calc_news_timediff_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/news_timediff_oa_types.csv") %>%
  mutate(type = factor(type, 
                       levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all news mentions received")

```

##### Blogs: OA versus non-OA ([query](queries/calc_blogs_timediff_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/blogs_timediff_oa.csv") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/blogs_min_timediff_oa.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.75, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all blog mentions received")

```

##### Blogs: all OA types ([query](queries/calc_blogs_timediff_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/blogs_timediff_oa_types.csv") %>%
  mutate(type = factor(type, 
                       levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all blog mentions received")

```

##### Wikipedia: OA versus non-OA ([query](queries/calc_wikipedia_timediff_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/wikipedia_timediff_oa.csv") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/wikipedia_min_timediff_oa.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.75, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 200.5)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all wikipedia citations received")

```

##### Wikipedia: all OA types ([query](queries/calc_wikipedia_timediff_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/wikipedia_timediff_oa_types.csv") %>%
  mutate(type = factor(type, 
                       levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all wikipedia citations received")

```

##### Policies: OA versus non-OA ([query](queries/calc_policy_timediff_oa.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/policy_timediff_oa.csv") %>%
  mutate(type = factor(type, levels = c("open", "closed"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  geom_point(data = read_csv("data/policy_min_timediff_oa.csv"),
             aes(x = median_min_timediff, y = 1, fill = type), 
             shape = 25, alpha = 0.75, size = 4, show.legend = F) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 300.5)) +
  scale_fill_manual(values = c(palette_color("open"), 
                               palette_color("closed"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all policy citations received")

```

##### Policies: all OA types ([query](queries/calc_policy_timediff_oa_types.sql))

```{r echo = F, message = F, warning = F, fig.height = 4, fig.width = 6}

read_csv("data/policy_timediff_oa_types.csv") %>%
  mutate(type = factor(type, 
                       levels = c("closed", "gold", "hybrid", "bronze", "green"))) %>%
  filter(timediff >= 0) %>%
  group_by(type) %>%
  arrange(timediff) %>%
  mutate(proportion = n_items/sum(n_items),
         cumulative_proportion = cumsum(proportion)) %>%
  ggplot() +
  geom_point(aes(x = timediff, y = cumulative_proportion, fill = type), 
             shape = 21, size = 2, alpha = 0.5) +
  scale_y_continuous(limit = c(0,1), labels = scales::percent) +
  scale_x_continuous(limit = c(-0.5, 100.5)) +
  scale_fill_manual(values = c(palette_color("closed"), 
                               palette_color("gold"),
                               palette_color("hybrid"),
                               palette_color("bronze"),
                               palette_color("green"))) +
  labs(x = "Time difference (days)",
       y = "Proportion of all policy citations received")

```

## Discussion: opportunities and limitations of using altmetrics to measure the 'social impact' of Open Access

Key points:

- Almost all units of analysis (years, subject classifications, countries, journal prestige) show a large 'altmetrics advantage' of OA publications over non-OA publications. A general exception appears to be in low-prestige (or at least low-IF) journals, where the opposite relationship is true.
- There exists great variability in the response of altmetrics to the *type* of OA, an example being in policy documents, where Gold OA is cited relatively less frequently than other forms of OA.
- The units of analysis here should not be considered in isolation, e.g. there is likely interaction between the country of authorship and subject classifications, as countries may prioritise research in different areas.
- The data gathered and presented above are purely observational, and thus it is difficult to extract causal relationships
- There exist significant barriers to overcome with respect to the data sources themselves, both for bibliometric databases and altmetrics sources.

The last point is explored in more detail below:

### Data Sources

#### Geographical bias in altmetrics data

##### Geographical bias in Twitter ([query](queries/calc_twitter_countries.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 16}

top_twitter_tweeter_countries <- read_csv("data/twitter_countries.csv") %>%
  group_by(tweeter_country) %>%
  summarize(n = sum(tweets)) %>%
  top_n(10, n) %>%
  pull(tweeter_country)

top_twitter_author_countries <- read_csv("data/twitter_countries.csv") %>%
  group_by(author_country) %>%
  summarize(n = sum(tweets)) %>%
  top_n(10, n) %>%
  pull(author_country)

read_csv("data/twitter_countries.csv") %>%
  mutate(
    author_country = case_when(
      author_country %in% top_twitter_author_countries ~ author_country,
      T ~ "Other"
    ),
    tweeter_country = case_when(
      tweeter_country %in% top_twitter_tweeter_countries ~ tweeter_country,
      T ~ "Other"
    )) %>%
  ggforce::gather_set_data(1:2) %>%
  ggplot(aes(x, id = id, split = y, value = tweets)) +
    ggforce::geom_parallel_sets(aes(fill = author_country), 
                                alpha = 0.5, sep = 0.03, n = 1000) +
    ggforce::geom_parallel_sets_axes(axis.width = 0.1, fill = "grey99", 
                                     color="grey75", sep = 0.03) +
    ggforce::geom_parallel_sets_labels(angle = 0, colour = "black", sep = 0.03) +
    theme_void() +
    theme(legend.position = "none") +
    viridis::scale_fill_viridis(discrete = T)

```

##### Geographical bias in policy documents ([query](queries/calc_policy_countries.sql))

```{r echo = F, message = F, warning = F, fig.height = 8, fig.width = 16}

top_policy_countries <- read_csv("data/policy_countries.csv") %>%
  group_by(policy_country) %>%
  summarize(n = sum(n_items)) %>%
  top_n(10, n) %>%
  pull(policy_country)

top_author_countries <- read_csv("data/policy_countries.csv") %>%
  group_by(author_country) %>%
  summarize(n = sum(n_items)) %>%
  top_n(10, n) %>%
  pull(author_country)

read_csv("data/policy_countries.csv") %>%
  mutate(
    author_country = case_when(
      author_country %in% top_author_countries ~ author_country,
      T ~ "Other"
    ),
    policy_country = case_when(
      policy_country %in% top_policy_countries ~ policy_country,
      T ~ "Other"
    )) %>%
  ggforce::gather_set_data(1:2) %>%
  ggplot(aes(x, id = id, split = y, value = n_items)) +
    ggforce::geom_parallel_sets(aes(fill = author_country), 
                                alpha = 0.5, sep = 0.03, n = 1000) +
    ggforce::geom_parallel_sets_axes(axis.width = 0.1, fill = "grey99", 
                                     color="grey75", sep = 0.03) +
    ggforce::geom_parallel_sets_labels(angle = 0, colour = "black", sep = 0.03) +
    theme_void() +
    theme(legend.position = "none") +
    viridis::scale_fill_viridis(discrete = T)

```



